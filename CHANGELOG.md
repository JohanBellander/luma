# Changelog

All notable changes to the LUMA project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

---

## [Unreleased]

### Added
- **Export Command (LUMA-119)** – Introduced `luma export` with initial `html-prototype` format for generating a lightweight semantic HTML artifact (`prototype.html`) from a scaffold or run folder. Supports options: `--out`, `--quick` (minimal markup), `--json` (metadata only), `--dry-run`, and `--run-id`. Adds node count & schemaVersion metadata. Documentation added to README & QUICKSTART. Test coverage via `test/export.command.test.ts`. Foundation for future formats (react-component, astro, markdown-doc).
- **Agent Command (`luma agent`)** – Runtime knowledge envelope providing sections (quick, workflow, rules, patterns, components, examples, links, meta) for AI agents. Enables selective inclusion via `--sections` and targeted retrieval via `--get <dotPath>`. Replaces large static AGENTS.md content with minimal pointer generated by `luma init`.
  - Deterministic output (stable key ordering) validated by test snapshots (excluding volatile `generatedAt` timestamp)
  - High-performance envelope build (<25ms direct function; median <800ms CLI spawn under Vitest) with de-duplication of repeated sections
  - Targeted retrieval via dot-path for nested keys (e.g. `rules.MUST`); returns structured errors for unknown paths
  - PowerShell-friendly section parsing (accepts comma or whitespace delimiters for `--sections quick rules` / `quick,rules`)
  - Explicit focus on machine readability for AI agents; minimal noise, stable ordering

### Changed
- `init` now writes concise `AGENTS.md` pointing to `luma agent` instead of embedding extensive rules.

### Notes
- Deterministic JSON structure (stable key ordering) except for `generatedAt`.
- Dot-path grammar intentionally limited to simple key traversal (no array indexing or wildcards). Deep filtering of arrays should be performed client-side after retrieving a full section.
- Unknown sections / paths emit structured errors with exit code 2.
- Future enhancement candidates (tracked separately): array indexing (`rules.MUST[0]`), wildcard selection, and partial section streaming.

---

## [0.1.97] - 2025-11-02

### Added
- **Analyze Command (LUMA-129)** – Single-pass pipeline: `ingest → layout → keyboard → flow → score` in one run folder via `luma analyze <file>`. Supports `--patterns <list>|auto`, `--viewports`, `--json`, consolidating multi-step workflows for AI agents.
- **Patterns Auto Token (LUMA-127)** – Accepts `--patterns auto` (or `--patterns=auto`) in `flow`, `validate`, and `analyze` to trigger high-confidence implicit pattern selection without specifying a manual list. JSON outputs include `autoSelected` array with confidence metadata.
- **Enhanced Error UX (LUMA-128 / 1.1.0)** – Error enhancer upgrades invalid node type & union mismatch messages with: valid type list, contextual example snippet, structural position guidance, and resolution hints referencing `luma explain scaffold-examples`.
- **New Documentation Topics (LUMA-126)** – Added topics: `scaffold-examples`, `pattern-usage`, `best-practices`, `error-glossary` for richer AI agent guidance (retrievable via `luma explain --topic <name>`).

### Changed
- Validation output now prioritizes and displays a single blocking error first (enhanced guidance) unless `--all-issues` provided.
- Pattern auto-selection integrated into `validate` and `analyze` flows when no explicit pattern list is supplied (with token support for explicit opt-in via `auto`).

### Documentation
- Expanded QUICKSTART to cover scaffold generation, auto pattern selection, enhanced error examples, and iteration flags.
- CHANGELOG cross-references agent feedback-driven improvements LUMA-126..130 for traceability.
- README updated with `--patterns auto`, analyze command usage, and enriched error snippet examples.

### DX
- Reduced multi-command friction through `luma analyze` consolidating artifact creation.
- Lower token & cognitive load: single critical error surface, optional suppression of non-blocking severities via `--errors-only` across core commands.
- Predictable pattern activation path (explicit list, implicit high-confidence auto selection, or suppression via `--no-auto`).

### Traceability
- Issues addressed: LUMA-126, LUMA-127, LUMA-128, LUMA-129, LUMA-130 (tests). Epic: LUMA-125.

---

## [0.1.76] - 2025-11-01

### Added
- **Errors-Only Filtering (LUMA-110)**: New `--errors-only` flag for `ingest`, `layout`, `keyboard`, and `flow` commands. Suppresses non-blocking severities (`warn`, `info`) from console output while preserving full JSON arrays and adding additive filtered collections:
  - `filteredIssues` (ingest, keyboard)
  - `filteredLayouts` (layout) – layout objects with only error/critical issues
  - `filteredPatterns` (flow) – pattern objects with only error/critical issues
  Backward-compatible: Original fields (`issues`, `layouts`, `patterns`) unchanged.

### Changed
- **Performance Test Thresholds**: Relaxed agent extended command spawn thresholds to reflect current baseline (median <1200ms, max <1800ms) pending further optimization work (LUMA-122).

### Rationale
- Reduces token usage for AI agents during iterative fix cycles by omitting noise.
- Provides concise blocker-focused artifacts without breaking existing integrations.

### Documentation
- Updated `README.md` and `QUICKSTART.md` with usage examples and JSON fragments for `--errors-only`.

### Internal
- Added new test files validating flag behavior for each command.
- Adjusted flow command to use `pattern` property consistently in filtered output.

### Backward Compatibility
- No breaking changes: feature is opt-in; existing scripts without the flag behave identically.

---


## [0.1.22] - 2025-10-30

### Added

#### Progressive Disclosure Pattern (Optional)
- **Progressive Disclosure Pattern Validator** - New optional UX pattern for validating progressive disclosure implementations:
  - Pattern name: `progressive-disclosure` (CLI) / `Progressive.Disclosure` (internal)
  - **Activation**: Inactive by default; activates when:
    - Explicitly requested via `luma flow --patterns progressive-disclosure`
    - Any node contains `behaviors.disclosure.collapsible === true` hint
  - **MUST Rules** (blocking, -30 points each):
    - `disclosure-no-control`: Collapsible containers must have an associated control
    - `disclosure-hides-primary`: Primary actions cannot be hidden by default in collapsed sections
    - `disclosure-missing-label`: Collapsible sections must have a label or summary
  - **SHOULD Rules** (warnings, -10 points each):
    - `disclosure-control-far`: Controls should be adjacent to collapsible content
    - `disclosure-inconsistent-affordance`: Multiple collapsibles should use consistent visual affordances
    - `disclosure-early-section`: Advanced sections should follow primary content

#### Schema Extensions (Non-breaking)
- **`behaviors.disclosure` hint** (optional):
  - `collapsible`: boolean - marks a container as collapsible
  - `defaultState`: `"collapsed"` | `"expanded"` - initial state (defaults to `"collapsed"`)
  - `controlsId`: string - ID of control Button/Text node
  - `ariaSummaryText`: string - optional accessible summary text
- **`affordances` field** (optional): string array for visual affordance hints (e.g., `["chevron"]`, `["details"]`, `["accordion"]`)
- All hints are optional and ignored if pattern is not activated

#### Pattern Integration
- **Inference Engine** - Automatic control detection when `controlsId` omitted:
  - Searches preceding siblings (reverse order)
  - Searches following siblings (forward order)
  - Searches header row (first child of container)
  - Matches on keywords: show, hide, expand, collapse, advanced, details, more
  - Falls back to affordances tokens: chevron, details
- **Pattern Registry** - Registered under aliases `progressive-disclosure` and `Progressive.Disclosure`
- **Scoring Impact** - Pattern failures affect "Pattern Fidelity" category (45% weight)
- **CLI Commands**:
  - `luma patterns --list` now includes Progressive Disclosure
  - `luma patterns --show Progressive.Disclosure` displays rules and sources
  - `luma flow --patterns progressive-disclosure` validates scaffolds

#### Testing & Quality
- **Unit Tests**:
  - Passing examples with valid disclosure implementations
  - MUST rule failure cases with error detection
  - SHOULD rule warning cases with proximity and consistency checks
  - Control inference with keyword and affordance matching
  - Suggestion generation for all issue IDs
- **Integration Tests**:
  - Pattern activation via explicit flag and automatic detection
  - Pattern scoring impact on overall score
  - Backward compatibility (pattern inactive without hints)
- **Performance**: < 5% increase in `validatePatterns` execution time

### Technical Details
- **Backward Compatibility**: Pattern is completely optional and inactive by default
  - Existing scaffolds without hints: no behavior change
  - Schema version remains `"1.0.0"` - no breaking changes
  - Pattern only runs when explicitly requested or hinted
- **Non-functional Requirements**:
  - Deterministic inference selection (precedence-based)
  - No performance regression in validation pipeline
- **Sources Cited**: Nielsen Norman Group, GOV.UK Design System, USWDS
- **Files Added**:
  - `src/core/patterns/progressive-disclosure.ts` - Pattern validator
  - `src/core/patterns/disclosure-inference.ts` - Control inference engine
  - `src/core/patterns/disclosure-utils.ts` - Helper utilities
  - `src/core/patterns/suggestions.ts` - Issue suggestion generator
  - `tests/unit/patterns/progressive-disclosure.test.ts` - Unit tests
  - `tests/integration/progressive-disclosure-activation.test.ts` - Activation tests
  - `tests/integration/progressive-disclosure-scoring.test.ts` - Scoring tests
  - `LUMA-PATTERN-Progressive-Disclosure-SPEC.md` - Full pattern specification

### Upgrade Notes
- **No migration required** - This is an additive feature
- Pattern hints (`behaviors.disclosure`, `affordances`) are ignored if omitted
- To use the pattern:
  - Option 1: Add `behaviors.disclosure.collapsible: true` to nodes in your scaffold
  - Option 2: Explicitly request via `luma flow --patterns progressive-disclosure`
- If you don't use progressive disclosure: no impact on your workflows or scores

---

## [1.1.0] - 2025-10-28

### Added

#### Scaffold Generation & Contract
- **Scaffold Contract Topic** - Added `scaffold-contract` topic to `luma explain` command, providing deterministic rules for scaffold generation that AI agents must follow
- **Golden Template** - Created reference template at `templates/golden.todo.mock.json` demonstrating a fully-validated scaffold structure
- **Golden Template Topic** - Added `golden-template` topic to `luma explain` command for quick access to the reference template
- **`luma scaffold new` Command** - New command to generate valid scaffolds from predefined patterns:
  - `todo-list` pattern - Complete task management UI with table
  - `empty-screen` pattern - Minimal valid scaffold for starting from scratch
  - Customization options: `--title`, `--screen-id`, `--breakpoints`, `--force`
  - Pre-validation during generation ensures output always passes `luma ingest`
- **AGENT-RULES-SCAFFOLD.md** - Standalone reference file documenting the scaffold contract for easy agent access

#### Enhanced Error Reporting
- **Enhanced Issue Types** - Added `expected` and `found` fields to Issue type for clearer validation feedback
- **Error Enhancement Wrapper** - Intelligent error prioritization and actionable suggestions:
  - Single-error-at-a-time output by default (most critical blocking issue)
  - Contextual fix suggestions with code snippets
  - JSON pointer references to exact error locations
  - `--all-issues` flag to show all validation errors
  - `--no-suggest` flag to suppress fix suggestions
  - Smart error prioritization: schema > missing > enum > type

#### Documentation & Testing
- **AI Agent Quickstart Guide** - Comprehensive `AI-AGENT-QUICKSTART.md` for agent onboarding
- **Phase 1 Integration Tests** - 27 tests validating scaffold contract, golden template, and scaffold generation through full LUMA pipeline
- **Backward Compatibility Tests** - Ensures all v1.0 scaffolds continue to work unchanged under v1.1

### Changed
- Enhanced validator error messages to include precise location information via JSON pointers
- Improved ingest command error output for better agent and developer experience

### Technical Details
- **Backward Compatibility**: All v1.0 scaffolds and commands work unchanged
- **Schema Version**: Input scaffolds still use `schemaVersion: "1.0.0"`
- **New Folders**: `templates/` for reference scaffolds
- **Files Added**: 
  - `src/cli/scaffold.command.ts`
  - `src/core/scaffold/generator.ts`
  - `src/core/scaffold/patterns.ts`
  - `src/core/ingest/error-enhancer.ts`
  - `tests/integration/v1.1-phase1.test.ts`
  - `tests/compatibility/v1.0-scaffolds.test.ts`

---

## [1.0.0] - 2025-10-xx

### Initial Release

#### Core Features
- **Ingest Command** - Validate scaffold JSON structure against schema
- **Layout Command** - Compute responsive layouts and detect overflow issues
- **Keyboard Command** - Analyze tab sequence and keyboard accessibility
- **Flow Command** - Validate UX patterns (forms, tables)
- **Score Command** - Aggregate scores across all analysis dimensions
- **Report Command** - Generate HTML reports with visualization
- **Patterns Command** - List available UX pattern validators

#### Layout System
- **Stack Layout** - Vertical and horizontal stacking with gap and padding
- **Grid Layout** - Responsive grid with columns, rows, and gap
- **Box Layout** - Single-child container with padding
- **Responsive Analysis** - Multi-viewport testing with configurable breakpoints

#### Keyboard Accessibility
- **Tab Sequence Generation** - Automatic focus order calculation
- **Flow Rules** - Detect tab traps, invalid sequences, and missing focusability
- **Focusable Detection** - Smart detection of interactive elements

#### UX Patterns
- **Form.Basic** - Form validation with MUST/SHOULD/MAY rules
- **Table.Simple** - Table pattern validation with responsive strategies

#### Developer Experience
- **Exit Codes** - Standardized codes for programmatic use (0=success, 1=validation failed, 2=warnings, 3=invalid usage, 4=IO error)
- **JSON Output** - All commands support `--json` flag for machine-readable output
- **Help Topics** - `luma explain --topic <name>` for detailed concept documentation
- **FAQ System** - `luma faq` for common questions
- **Init Command** - `luma init` to set up LUMA in projects with agent instructions

#### Testing & Quality
- 191 tests across 18 test files
- Unit tests for all core modules
- Integration tests for complete workflows
- Example scaffolds in `examples/` directory

#### Technical Stack
- TypeScript 5.x with strict mode
- Commander.js for CLI
- Zod for schema validation
- Vitest for testing
- Node.js >= 18.0.0

---

## Release Notes

### v1.1.0 Highlights

This release focuses on **AI agent enablement** and **developer experience improvements**:

1. **Scaffold Generation** - Agents can now generate valid scaffolds using `luma scaffold new` instead of hand-crafting JSON
2. **Clear Contracts** - The scaffold contract topic removes ambiguity about what makes a valid scaffold
3. **Better Errors** - Enhanced error messages guide users to fixes faster with contextual suggestions
4. **Golden Template** - A reference scaffold provides a working example to learn from

All additions are **backward-compatible** - existing v1.0 scaffolds and workflows continue to work unchanged.

### Migration from v1.0

No migration needed! All v1.0 features work identically in v1.1. New features are purely additive:
- Use `luma scaffold new` if you want to generate scaffolds instead of writing JSON manually
- Use `luma explain --topic scaffold-contract` for contract reference
- Error messages are more helpful, but same exit codes and validation rules apply

---

[0.1.22]: https://github.com/JohanBellander/luma/compare/v0.1.21...v0.1.22
[0.1.76]: https://github.com/JohanBellander/luma/compare/v0.1.75...v0.1.76
[1.1.0]: https://github.com/JohanBellander/luma/compare/v1.0.0...v1.1.0
[1.0.0]: https://github.com/JohanBellander/luma/releases/tag/v1.0.0
